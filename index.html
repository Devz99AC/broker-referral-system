<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broker Referral System - Enhanced Registration</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .status-badge { @apply px-3 py-1 rounded-full text-sm font-medium; }
        .status-initial { @apply bg-gray-200 text-gray-800; }
        .status-progress { @apply bg-blue-200 text-blue-800; }
        .status-completed { @apply bg-green-200 text-green-800; }
        .status-hold { @apply bg-yellow-200 text-yellow-800; }
        .status-cancelled { @apply bg-red-200 text-red-800; }
        .progress-bar { transition: width 0.3s ease-in-out; }
        .notification { @apply fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300; }
        .notification.success { @apply bg-green-500 text-white; }
        .notification.error { @apply bg-red-500 text-white; }
        .notification.info { @apply bg-blue-500 text-white; }
        .nav-item { @apply cursor-pointer px-4 py-2 rounded-lg transition-colors duration-200; }
        .nav-item:hover { @apply bg-blue-700; }
        .nav-item.active { @apply bg-blue-800; }
        .form-group { @apply mb-4; }
        .form-label { @apply block text-sm font-medium text-gray-700 mb-2; }
        .form-input { @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent; }
        .btn-primary { @apply bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200; }
        .btn-secondary { @apply bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200; }
        .btn-success { @apply bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200; }
        .btn-danger { @apply bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200; }
        .table-row:hover { @apply bg-gray-50; }
        .step-indicator { @apply flex items-center justify-center w-8 h-8 rounded-full text-sm font-medium; }
        .step-completed { @apply bg-green-500 text-white; }
        .step-active { @apply bg-blue-500 text-white; }
        .step-pending { @apply bg-gray-300 text-gray-600; }
         {
            body { font-size: 12px; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <span class="text-gray-700">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Login/Registration Screen -->
    <div id="authScreen" class="min-h-screen gradient-bg flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div class="text-center">
                <h1 class="text-4xl font-bold text-white mb-2">Broker Referral System</h1>
                <p class="text-blue-100">Manage your client referrals with ease</p>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm" class="bg-white rounded-lg shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-900 text-center mb-6">Sign In</h2>
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="loginUsername" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="loginPassword" class="form-input" required>
                    </div>
                    <button type="submit" class="w-full btn-primary">Sign In</button>
                </form>
                <div class="mt-6 text-center">
                    <p class="text-sm text-gray-600">Don't have an account?</p>
                    <button onclick="showRegistration()" class="text-blue-600 hover:text-blue-800 font-medium">Register as Broker</button>
                </div>
                <div class="mt-4 bg-gray-50 p-4 rounded-lg">
                    <p class="text-xs text-gray-600 mb-2">Demo Accounts:</p>
                    <p class="text-xs"><strong>Admin:</strong> admin / admin123</p>
                    <p class="text-xs"><strong>Broker:</strong> broker1 / password</p>
                    <p class="text-xs"><strong>Sales Rep:</strong> salesrep1 / password</p>
                </div>
            </div>

            <!-- Registration Form -->
            <div id="registrationForm" class="bg-white rounded-lg shadow-lg p-8 hidden">
                <h2 class="text-2xl font-bold text-gray-900 text-center mb-6">Broker Registration</h2>
                
                <!-- Registration Steps -->
                <div class="flex justify-between mb-8">
                    <div class="flex flex-col items-center">
                        <div id="step1" class="step-indicator step-active">1</div>
                        <span class="text-xs mt-1">Details</span>
                    </div>
                    <div class="flex-1 h-px bg-gray-300 self-center mx-2"></div>
                    <div class="flex flex-col items-center">
                        <div id="step2" class="step-indicator step-pending">2</div>
                        <span class="text-xs mt-1">Verify</span>
                    </div>
                    <div class="flex-1 h-px bg-gray-300 self-center mx-2"></div>
                    <div class="flex flex-col items-center">
                        <div id="step3" class="step-indicator step-pending">3</div>
                        <span class="text-xs mt-1">Approval</span>
                    </div>
                </div>

                <!-- Step 1: Basic Information -->
                <div id="regStep1">
                    <form onsubmit="handleRegistrationStep1(event)">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">First Name *</label>
                                <input type="text" id="firstName" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Last Name *</label>
                                <input type="text" id="lastName" class="form-input" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address *</label>
                            <input type="email" id="email" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number *</label>
                            <input type="tel" id="phone" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Company/Agency Name</label>
                            <input type="text" id="company" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">License Number</label>
                            <input type="text" id="license" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Preferred Username *</label>
                            <input type="text" id="username" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password *</label>
                            <input type="password" id="password" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm Password *</label>
                            <input type="password" id="confirmPassword" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Primary Service Focus</label>
                            <select id="serviceFocus" class="form-input">
                                <option value="">Select Service Focus</option>
                                <option value="WSC">WSC - Workers' Compensation</option>
                                <option value="FP">FP - Financial Products</option>
                                <option value="CCC">CCC - Credit & Collections</option>
                                <option value="All">All Services</option>
                            </select>
                        </div>
                        <div class="flex justify-between">
                            <button type="button" onclick="showLogin()" class="btn-secondary">Back to Login</button>
                            <button type="submit" class="btn-primary">Continue</button>
                        </div>
                    </form>
                </div>

                <!-- Step 2: Email Verification -->
                <div id="regStep2" class="hidden">
                    <div class="text-center mb-6">
                        <i class="fas fa-envelope-circle-check text-4xl text-blue-500 mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-900">Verify Your Email</h3>
                        <p class="text-gray-600">We've sent a verification code to <span id="emailDisplay" class="font-medium"></span></p>
                    </div>
                    <form onsubmit="handleEmailVerification(event)">
                        <div class="form-group">
                            <label class="form-label">Verification Code</label>
                            <input type="text" id="verificationCode" class="form-input text-center" placeholder="Enter 6-digit code" maxlength="6" required>
                        </div>
                        <div class="flex justify-between">
                            <button type="button" onclick="backToStep1()" class="btn-secondary">Back</button>
                            <button type="submit" class="btn-primary">Verify Email</button>
                        </div>
                        <div class="mt-4 text-center">
                            <button type="button" onclick="resendCode()" class="text-blue-600 hover:text-blue-800 text-sm">Didn't receive code? Resend</button>
                        </div>
                    </form>
                    <div class="mt-4 bg-blue-50 p-3 rounded-lg">
                        <p class="text-xs text-blue-600">Demo: Use verification code <strong>123456</strong></p>
                    </div>
                </div>

                <!-- Step 3: Pending Approval -->
                <div id="regStep3" class="hidden">
                    <div class="text-center">
                        <i class="fas fa-clock text-4xl text-yellow-500 mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-900">Pending Admin Approval</h3>
                        <p class="text-gray-600 mb-6">Your registration has been submitted and is pending admin approval. You'll receive an email notification once approved.</p>
                        <div class="bg-green-50 p-4 rounded-lg mb-6">
                            <h4 class="font-medium text-green-900 mb-2">Registration Details:</h4>
                            <div id="registrationSummary" class="text-sm text-green-700"></div>
                        </div>
                        <button onclick="showLogin()" class="btn-primary">Back to Login</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold text-gray-900">Broker Referral System</h1>
                        <span id="userWelcome" class="text-gray-600"></span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <span id="sfStatus" class="text-sm text-gray-600">SF: Disconnected</span>
                            <div id="sfIndicator" class="w-3 h-3 rounded-full bg-red-500"></div>
                        </div>
                        <button onclick="logout()" class="btn-secondary">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-blue-600 text-white">
            <div class="px-6">
                <div class="flex space-x-1" id="navigationMenu"></div>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="p-6">
            <!-- Dashboard -->
            <div id="dashboardContent">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <i class="fas fa-users text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Clients</p>
                                <p class="text-2xl font-semibold text-gray-900" id="totalClients">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <i class="fas fa-check-circle text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Completed</p>
                                <p class="text-2xl font-semibold text-gray-900" id="completedClients">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                <i class="fas fa-clock text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">In Progress</p>
                                <p class="text-2xl font-semibold text-gray-900" id="progressClients">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                <i class="fas fa-chart-line text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">This Month</p>
                                <p class="text-2xl font-semibold text-gray-900" id="monthlyClients">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Client List -->
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-semibold text-gray-900">Client Progress Tracking</h2>
                            <div class="flex space-x-4">
                                <select id="companyFilter" class="form-input w-auto" onchange="filterClients()">
                                    <option value="">All Companies</option>
                                    <option value="WSC">WSC</option>
                                    <option value="FP">FP</option>
                                    <option value="CCC">CCC</option>
                                </select>
                                <select id="statusFilter" class="form-input w-auto" onchange="filterClients()">
                                    <option value="">All Statuses</option>
                                    <option value="Initial">Initial</option>
                                    <option value="Work Started">Work Started</option>
                                    <option value="Work Completed">Work Completed</option>
                                </select>
                                <button onclick="showAddClientModal()" class="btn-primary" id="addClientBtn" style="display: none;">
                                    <i class="fas fa-plus mr-2"></i>Add Client
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Broker</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Updated</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clientTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin Panel -->
            <div id="adminContent" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- User Management -->
                    <div class="lg:col-span-2 bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-900">User Management</h2>
                        </div>
                        <div class="p-6">
                            <div class="mb-4">
                                <div class="flex justify-between items-center">
                                    <h3 class="font-medium text-gray-900">Pending Registrations</h3>
                                    <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full" id="pendingCount">0</span>
                                </div>
                            </div>
                            <div id="pendingRegistrations" class="mb-6"></div>
                            
                            <div class="mb-4">
                                <h3 class="font-medium text-gray-900">Active Users</h3>
                            </div>
                            <div id="activeUsers"></div>
                        </div>
                    </div>

                    <!-- System Settings -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-900">System Settings</h2>
                        </div>
                        <div class="p-6 space-y-4">
                            <div>
                                <h3 class="font-medium text-gray-900 mb-2">Salesforce Integration</h3>
                                <div class="space-y-2">
                                    <button onclick="showSalesforceConfig()" class="w-full btn-primary">
                                        <i class="fas fa-cog mr-2"></i>Configure SF Connection
                                    </button>
                                    <button onclick="syncWithSalesforce()" class="w-full btn-secondary">
                                        <i class="fas fa-sync mr-2"></i>Sync Data
                                    </button>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-medium text-gray-900 mb-2">System Status</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>Database:</span>
                                        <span class="text-green-600">Online</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Salesforce:</span>
                                        <span id="sfStatusText" class="text-red-600">Disconnected</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Last Sync:</span>
                                        <span class="text-gray-600">Never</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Settings -->
            <div id="profileContent" class="hidden">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-900">Profile Settings</h2>
                        </div>
                        <div class="p-6">
                            <form onsubmit="updateProfile(event)">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="form-group">
                                        <label class="form-label">First Name</label>
                                        <input type="text" id="profileFirstName" class="form-input">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Last Name</label>
                                        <input type="text" id="profileLastName" class="form-input">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Email</label>
                                        <input type="email" id="profileEmail" class="form-input">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Phone</label>
                                        <input type="tel" id="profilePhone" class="form-input">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Company</label>
                                        <input type="text" id="profileCompany" class="form-input">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">License Number</label>
                                        <input type="text" id="profileLicense" class="form-input">
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <button type="submit" class="btn-primary">Update Profile</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Client Modal -->
    <div id="addClientModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Add New Client</h2>
            </div>
            <div class="p-6">
                <form onsubmit="addClient(event)">
                    <div class="form-group">
                        <label class="form-label">Client Name</label>
                        <input type="text" id="clientName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="clientEmail" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" id="clientPhone" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Company</label>
                        <select id="clientCompany" class="form-input" required>
                            <option value="">Select Company</option>
                            <option value="WSC">WSC</option>
                            <option value="FP">FP</option>
                            <option value="CCC">CCC</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeAddClientModal()" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-primary">Add Client</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Salesforce Configuration Modal -->
    <div id="salesforceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg max-w-lg w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Salesforce Configuration</h2>
            </div>
            <div class="p-6">
                <form onsubmit="saveSalesforceConfig(event)">
                    <div class="form-group">
                        <label class="form-label">Instance URL</label>
                        <input type="url" id="sfInstanceUrl" class="form-input" placeholder="https://yourinstance.salesforce.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Client ID</label>
                        <input type="text" id="sfClientId" class="form-input" placeholder="Connected App Client ID">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Client Secret</label>
                        <input type="password" id="sfClientSecret" class="form-input" placeholder="Connected App Client Secret">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="sfUsername" class="form-input" placeholder="Salesforce Username">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password + Security Token</label>
                        <input type="password" id="sfPassword" class="form-input" placeholder="Password + Security Token">
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <h4 class="font-medium text-blue-900 mb-2">Setup Instructions:</h4>
                        <ol class="text-sm text-blue-700 list-decimal list-inside space-y-1">
                            <li>Create a Connected App in Salesforce</li>
                            <li>Enable OAuth settings with required scopes</li>
                            <li>Set callback URL to your domain</li>
                            <li>Create custom objects for referral tracking</li>
                        </ol>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeSalesforceModal()" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-primary">Save & Test Connection</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let currentUser = null;
        let currentView = 'dashboard';
        let clients = [];
        let users = [];
        let pendingRegistrations = [];

        // Company Status Definitions
        const companyStatuses = {
            general: ['Initial', 'Work Started', 'Work Completed'],
            WSC: [
                'Get Signed docs', 'Get Setup Interview', 'Deliver Features',
                'On Hold - Waiting Fe', 'On Hold - Other Reason', 'On Hold - Waiting FE - Filed',
                'On Hold - Waiting FE - Client to File', 'On Hold - Reinstate - Client to File',
                'On Hold - Reinstate - Filed'
            ],
            FP: [
                'Deliver CP', 'Match Completed', 'Funding Completed', 'Deliver Features',
                'Give Introduction', 'Get Setup Interview', 'Get Corp into Funding',
                'Get Corp Funded', 'Compliance', 'Complete'
            ],
            CCC: [
                'New', 'Get Credit Report', 'CCC Review', 'CCC Get Credit-Ready',
                'CCC Get 80 Paydex', 'Initial Credit Analysis', 'Analysis',
                'Analysis - Incomplete', 'Understanding Your Options', 'Select Lenders',
                'Apps', 'Compliance', 'Complete', 'In Collections',
                'Cancelled - Duplicate', 'Cancelled - Client Request', 'On Hold - CCC',
                'On Hold - FU', 'Submit Apps'
            ]
        };

        // Initialize sample data
        function initializeSampleData() {
            // Sample users
            users = [
                { id: 1, username: 'admin', password: 'admin123', role: 'admin', firstName: 'System', lastName: 'Administrator', email: 'admin@company.com', status: 'active' },
                { id: 2, username: 'broker1', password: 'password', role: 'broker', firstName: 'John', lastName: 'Smith', email: 'john@broker.com', company: 'Smith Insurance', status: 'active' },
                { id: 3, username: 'salesrep1', password: 'password', role: 'salesrep', firstName: 'Sarah', lastName: 'Johnson', email: 'sarah@company.com', status: 'active' }
            ];

            // Sample clients
            clients = [
                {
                    id: 1, name: 'ABC Corporation', email: 'contact@abc.com', phone: '555-0101',
                    company: 'WSC', status: 'Get Signed docs', progress: 20, broker: 'John Smith',
                    lastUpdated: '2024-01-15', notes: 'Waiting for signed documents'
                },
                {
                    id: 2, name: 'XYZ Industries', email: 'info@xyz.com', phone: '555-0102',
                    company: 'FP', status: 'Match Completed', progress: 60, broker: 'John Smith',
                    lastUpdated: '2024-01-14', notes: 'Match process completed successfully'
                },
                {
                    id: 3, name: 'Tech Solutions LLC', email: 'hello@techsol.com', phone: '555-0103',
                    company: 'CCC', status: 'CCC Review', progress: 40, broker: 'John Smith',
                    lastUpdated: '2024-01-13', notes: 'Under review process'
                }
            ];

            // Sample pending registrations
            pendingRegistrations = [
                {
                    id: 1, firstName: 'Mike', lastName: 'Wilson', email: 'mike@broker.com',
                    company: 'Wilson Insurance', phone: '555-0201', serviceFocus: 'WSC',
                    submittedDate: '2024-01-10', status: 'pending'
                }
            ];
        }

        // Notification System
        function showNotification(message, type = 'info', duration = 3000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            container.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        }

        // Authentication Functions
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            const user = users.find(u => u.username === username && u.password === password && u.status === 'active');
            
            if (user) {
                currentUser = user;
                showMainApp();
                showNotification(`Welcome back, ${user.firstName}!`, 'success');
            } else {
                showNotification('Invalid credentials or account not approved', 'error');
            }
        }

        function showRegistration() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registrationForm').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registrationForm').classList.add('hidden');
            resetRegistrationForm();
        }

        function resetRegistrationForm() {
            document.getElementById('regStep1').classList.remove('hidden');
            document.getElementById('regStep2').classList.add('hidden');
            document.getElementById('regStep3').classList.add('hidden');
            updateStepIndicators(1);
        }

        function updateStepIndicators(step) {
            const steps = ['step1', 'step2', 'step3'];
            steps.forEach((stepId, index) => {
                const element = document.getElementById(stepId);
                element.className = 'step-indicator ';
                if (index + 1 < step) {
                    element.className += 'step-completed';
                } else if (index + 1 === step) {
                    element.className += 'step-active';
                } else {
                    element.className += 'step-pending';
                }
            });
        }

        function handleRegistrationStep1(event) {
            event.preventDefault();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }

            const email = document.getElementById('email').value;
            document.getElementById('emailDisplay').textContent = email;
            
            document.getElementById('regStep1').classList.add('hidden');
            document.getElementById('regStep2').classList.remove('hidden');
            updateStepIndicators(2);
        }

        function backToStep1() {
            document.getElementById('regStep2').classList.add('hidden');
            document.getElementById('regStep1').classList.remove('hidden');
            updateStepIndicators(1);
        }

        function handleEmailVerification(event) {
            event.preventDefault();
            const code = document.getElementById('verificationCode').value;
            
            if (code === '123456') {
                // Create registration record
                const registration = {
                    id: Date.now(),
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    company: document.getElementById('company').value,
                    license: document.getElementById('license').value,
                    username: document.getElementById('username').value,
                    serviceFocus: document.getElementById('serviceFocus').value,
                    submittedDate: new Date().toISOString().split('T')[0],
                    status: 'pending'
                };

                pendingRegistrations.push(registration);
                
                const summary = `
                    <p><strong>Name:</strong> ${registration.firstName} ${registration.lastName}</p>
                    <p><strong>Email:</strong> ${registration.email}</p>
                    <p><strong>Company:</strong> ${registration.company}</p>
                    <p><strong>Service Focus:</strong> ${registration.serviceFocus}</p>
                `;
                document.getElementById('registrationSummary').innerHTML = summary;
                
                document.getElementById('regStep2').classList.add('hidden');
                document.getElementById('regStep3').classList.remove('hidden');
                updateStepIndicators(3);
            } else {
                showNotification('Invalid verification code', 'error');
            }
        }

        function resendCode() {
            showNotification('Verification code resent to your email', 'info');
        }

        function logout() {
            currentUser = null;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('authScreen').classList.remove('hidden');
            showLogin();
        }

        // Main Application Functions
        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            setupNavigation();
            loadDashboard();
            updateUserWelcome();
        }

        function updateUserWelcome() {
            document.getElementById('userWelcome').textContent = `Welcome, ${currentUser.firstName} ${currentUser.lastName} (${currentUser.role.toUpperCase()})`;
        }

        function setupNavigation() {
            const nav = document.getElementById('navigationMenu');
            nav.innerHTML = '';

            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-tachometer-alt', roles: ['broker', 'admin', 'salesrep'] },
                { id: 'profile', label: 'Profile', icon: 'fas fa-user', roles: ['broker', 'admin', 'salesrep'] },
                { id: 'admin', label: 'Admin Panel', icon: 'fas fa-cogs', roles: ['admin'] }
            ];

            navItems.forEach(item => {
                if (item.roles.includes(currentUser.role)) {
                    const navItem = document.createElement('div');
                    navItem.className = `nav-item ${item.id === currentView ? 'active' : ''}`;
                    navItem.innerHTML = `<i class="${item.icon} mr-2"></i>${item.label}`;
                    navItem.onclick = () => showView(item.id);
                    nav.appendChild(navItem);
                }
            });

            // Show/hide add client button based on role
            const addClientBtn = document.getElementById('addClientBtn');
            if (currentUser.role === 'admin' || currentUser.role === 'salesrep') {
                addClientBtn.style.display = 'block';
            }
        }

        function showView(viewId) {
            // Hide all content areas
            ['dashboardContent', 'adminContent', 'profileContent'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show selected view
            currentView = viewId;
            switch(viewId) {
                case 'dashboard':
                    document.getElementById('dashboardContent').classList.remove('hidden');
                    loadDashboard();
                    break;
                case 'admin':
                    document.getElementById('adminContent').classList.remove('hidden');
                    loadAdminPanel();
                    break;
                case 'profile':
                    document.getElementById('profileContent').classList.remove('hidden');
                    loadProfile();
                    break;
            }
        }

        function loadDashboard() {
            // Update statistics
            const totalClients = clients.length;
            const completedClients = clients.filter(c => c.status.includes('Complete')).length;
            const progressClients = clients.filter(c => !c.status.includes('Complete') && c.status !== 'Initial').length;
            const monthlyClients = clients.filter(c => new Date(c.lastUpdated).getMonth() === new Date().getMonth()).length;

            document.getElementById('totalClients').textContent = totalClients;
            document.getElementById('completedClients').textContent = completedClients;
            document.getElementById('progressClients').textContent = progressClients;
            document.getElementById('monthlyClients').textContent = monthlyClients;

            // Load client table
            renderClientTable();
        }

        function renderClientTable() {
            const tbody = document.getElementById('clientTableBody');
            tbody.innerHTML = '';

            let filteredClients = clients;
            
            // Apply filters if user is broker
            if (currentUser.role === 'broker') {
                filteredClients = clients.filter(c => c.broker === `${currentUser.firstName} ${currentUser.lastName}`);
            }

            // Apply company and status filters
            const companyFilter = document.getElementById('companyFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            if (companyFilter) {
                filteredClients = filteredClients.filter(c => c.company === companyFilter);
            }
            if (statusFilter) {
                filteredClients = filteredClients.filter(c => c.status === statusFilter);
            }

            filteredClients.forEach(client => {
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                            <div class="text-sm font-medium text-gray-900">${client.name}</div>
                            <div class="text-sm text-gray-500">${client.email}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${client.company}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge ${getStatusClass(client.status)}">${client.status}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                                <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: ${client.progress}%"></div>
                            </div>
                            <span class="text-sm text-gray-600">${client.progress}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${client.broker}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.lastUpdated}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewClientDetails(${client.id})" class="text-blue-600 hover:text-blue-900 mr-3">View</button>
                        ${currentUser.role !== 'broker' ? `<button onclick="editClient(${client.id})" class="text-green-600 hover:text-green-900">Edit</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getStatusClass(status) {
            if (status.includes('Complete')) return 'status-completed';
            if (status.includes('Hold') || status.includes('Waiting')) return 'status-hold';
            if (status.includes('Cancelled')) return 'status-cancelled';
            if (status === 'Initial') return 'status-initial';
            return 'status-progress';
        }

        function filterClients() {
            renderClientTable();
        }

        function loadAdminPanel() {
            renderPendingRegistrations();
            renderActiveUsers();
            updatePendingCount();
        }

        function renderPendingRegistrations() {
            const container = document.getElementById('pendingRegistrations');
            container.innerHTML = '';

            if (pendingRegistrations.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No pending registrations</p>';
                return;
            }

            pendingRegistrations.forEach(registration => {
                const item = document.createElement('div');
                item.className = 'border rounded-lg p-4 mb-3 bg-yellow-50';
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-gray-900">${registration.firstName} ${registration.lastName}</h4>
                            <p class="text-sm text-gray-600">${registration.email}</p>
                            <p class="text-sm text-gray-600">${registration.company} • ${registration.serviceFocus}</p>
                            <p class="text-xs text-gray-500">Submitted: ${registration.submittedDate}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="approveRegistration(${registration.id})" class="btn-success text-xs px-3 py-1">Approve</button>
                            <button onclick="rejectRegistration(${registration.id})" class="btn-danger text-xs px-3 py-1">Reject</button>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function renderActiveUsers() {
            const container = document.getElementById('activeUsers');
            container.innerHTML = '';

            const activeUsers = users.filter(u => u.status === 'active');
            activeUsers.forEach(user => {
                const item = document.createElement('div');
                item.className = 'border rounded-lg p-4 mb-3';
                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-medium text-gray-900">${user.firstName} ${user.lastName}</h4>
                            <p class="text-sm text-gray-600">${user.email} • ${user.role.toUpperCase()}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="status-badge status-completed">Active</span>
                            ${user.role !== 'admin' ? `<button onclick="deactivateUser(${user.id})" class="btn-danger text-xs px-3 py-1">Deactivate</button>` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function updatePendingCount() {
            document.getElementById('pendingCount').textContent = pendingRegistrations.length;
        }

        function approveRegistration(id) {
            const registration = pendingRegistrations.find(r => r.id === id);
            if (registration) {
                // Create new user account
                const newUser = {
                    id: users.length + 1,
                    username: registration.email, // Use email as username
                    password: 'temp123', // Temporary password
                    role: 'broker',
                    firstName: registration.firstName,
                    lastName: registration.lastName,
                    email: registration.email,
                    phone: registration.phone,
                    company: registration.company,
                    license: registration.license,
                    status: 'active'
                };
                
                users.push(newUser);
                pendingRegistrations = pendingRegistrations.filter(r => r.id !== id);
                
                renderPendingRegistrations();
                renderActiveUsers();
                updatePendingCount();
                
                showNotification(`${registration.firstName} ${registration.lastName} has been approved and can now login`, 'success');
            }
        }

        function rejectRegistration(id) {
            const registration = pendingRegistrations.find(r => r.id === id);
            if (registration && confirm(`Are you sure you want to reject ${registration.firstName} ${registration.lastName}'s registration?`)) {
                pendingRegistrations = pendingRegistrations.filter(r => r.id !== id);
                renderPendingRegistrations();
                updatePendingCount();
                showNotification('Registration rejected', 'info');
            }
        }

        function deactivateUser(id) {
            const user = users.find(u => u.id === id);
            if (user && confirm(`Are you sure you want to deactivate ${user.firstName} ${user.lastName}?`)) {
                user.status = 'inactive';
                renderActiveUsers();
                showNotification('User deactivated', 'info');
            }
        }

        function loadProfile() {
            // Load current user data into profile form
            document.getElementById('profileFirstName').value = currentUser.firstName || '';
            document.getElementById('profileLastName').value = currentUser.lastName || '';
            document.getElementById('profileEmail').value = currentUser.email || '';
            document.getElementById('profilePhone').value = currentUser.phone || '';
            document.getElementById('profileCompany').value = currentUser.company || '';
            document.getElementById('profileLicense').value = currentUser.license || '';
        }

        function updateProfile(event) {
            event.preventDefault();
            // Update current user data
            currentUser.firstName = document.getElementById('profileFirstName').value;
            currentUser.lastName = document.getElementById('profileLastName').value;
            currentUser.email = document.getElementById('profileEmail').value;
            currentUser.phone = document.getElementById('profilePhone').value;
            currentUser.company = document.getElementById('profileCompany').value;
            currentUser.license = document.getElementById('profileLicense').value;
            
            // Update in users array
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = { ...currentUser };
            }
            
            updateUserWelcome();
            showNotification('Profile updated successfully', 'success');
        }

        // Client Management Functions
        function showAddClientModal() {
            document.getElementById('addClientModal').classList.remove('hidden');
        }

        function closeAddClientModal() {
            document.getElementById('addClientModal').classList.add('hidden');
            document.getElementById('addClientModal').querySelector('form').reset();
        }

        function addClient(event) {
            event.preventDefault();
            const newClient = {
                id: clients.length + 1,
                name: document.getElementById('clientName').value,
                email: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value,
                company: document.getElementById('clientCompany').value,
                status: 'Initial',
                progress: 0,
                broker: `${currentUser.firstName} ${currentUser.lastName}`,
                lastUpdated: new Date().toISOString().split('T')[0],
                notes: 'New client added'
            };
            
            clients.push(newClient);
            closeAddClientModal();
            renderClientTable();
            loadDashboard();
            showNotification('Client added successfully', 'success');
        }

        function viewClientDetails(id) {
            const client = clients.find(c => c.id === id);
            if (client) {
                alert(`Client Details:\n\nName: ${client.name}\nEmail: ${client.email}\nPhone: ${client.phone}\nCompany: ${client.company}\nStatus: ${client.status}\nProgress: ${client.progress}%\nBroker: ${client.broker}\nNotes: ${client.notes}`);
            }
        }

        function editClient(id) {
            // Simplified edit functionality
            const client = clients.find(c => c.id === id);
            if (client) {
                const newStatus = prompt(`Current Status: ${client.status}\n\nEnter new status:`, client.status);
                if (newStatus && newStatus !== client.status) {
                    client.status = newStatus;
                    client.lastUpdated = new Date().toISOString().split('T')[0];
                    
                    // Update progress based on status
                    if (newStatus.includes('Complete')) {
                        client.progress = 100;
                    } else if (newStatus === 'Initial') {
                        client.progress = 10;
                    } else {
                        client.progress = Math.min(client.progress + 20, 90);
                    }
                    
                    renderClientTable();
                    showNotification('Client status updated', 'success');
                }
            }
        }

        // Salesforce Integration Functions
        function showSalesforceConfig() {
            document.getElementById('salesforceModal').classList.remove('hidden');
        }

        function closeSalesforceModal() {
            document.getElementById('salesforceModal').classList.add('hidden');
        }

        function saveSalesforceConfig(event) {
            event.preventDefault();
            // Simulate saving configuration
            const config = {
                instanceUrl: document.getElementById('sfInstanceUrl').value,
                clientId: document.getElementById('sfClientId').value,
                clientSecret: document.getElementById('sfClientSecret').value,
                username: document.getElementById('sfUsername').value,
                password: document.getElementById('sfPassword').value
            };
            
            // Simulate connection test
            setTimeout(() => {
                if (config.instanceUrl && config.clientId) {
                    updateSalesforceStatus(true);
                    showNotification('Salesforce connection successful!', 'success');
                } else {
                    showNotification('Please fill in all required fields', 'error');
                }
                closeSalesforceModal();
            }, 1000);
        }

        function updateSalesforceStatus(connected) {
            const status = document.getElementById('sfStatus');
            const indicator = document.getElementById('sfIndicator');
            const statusText = document.getElementById('sfStatusText');
            
            if (connected) {
                status.textContent = 'SF: Connected';
                indicator.className = 'w-3 h-3 rounded-full bg-green-500';
                statusText.textContent = 'Connected';
                statusText.className = 'text-green-600';
            } else {
                status.textContent = 'SF: Disconnected';
                indicator.className = 'w-3 h-3 rounded-full bg-red-500';
                statusText.textContent = 'Disconnected';
                statusText.className = 'text-red-600';
            }
        }

        function syncWithSalesforce() {
            showNotification('Syncing with Salesforce...', 'info');
            // Simulate sync process
            setTimeout(() => {
                showNotification('Sync completed successfully', 'success');
            }, 2000);
        }

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            initializeSampleData();
            console.log('Broker Referral System initialized');
        });
    </script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDqGkTPcj0j7g4MvzK1rwRbAH8JP%2F%2BQ%2FZPuzTkpQOkv9S0vABJ4jdwISCbks4x%2FnIQDqm3nzmKFEFCFy3eFyzfgMdxvF9XKAD6M9qe%2BaM%2Fmd8QVybeGjxMba%2F9U23JUS0Hy9WOq38PBZMprP5sKw1nRf9IRa25TSD6fWzSWpSNplWeeh7Trj0KAFwJr0QaEITGuWu4nSqUwmk9mREe%2BySFzUWURp1yzki1Z%2BZ0ZaFXQM3VxcNB9xdDntk2KBbVY0PxSyoBlAXfZhkuTp3usR%2B5FM2mhngJ8Awp42QgGbVLEPRsLJT2NGF1%2F%2FKyioEnG%2B5ceoIj%2FbqYygPBkMCTL%2BM%2FSJPeAf7DJ9WNRsD0d7mU8EwMd6tIJKJULEzQ3bQLUBfhg8Y1KfIrcjqMFmbTLiwaq3dZE%2BKxwSMd5JAeOR0iBUc5YenaWzysRZMt5LBLd%2FmgeTuPIF7fSdt6u4KxWho5qRWahibjLst%2BEUNFPAUmeQT4jJiEMLyGlQk284%2FTP6YrDY88azMuKnTmyqS%2FQTnWFU%3D";
        window.__genspark_locale = "es-ES";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDqGkTPcj0j7g4MvzK1rwRbAH8JP/+Q/ZPuzTkpQOkv9S0vABJ4jdwISCbks4x/nIQDqm3nzmKFEFCFy3eFyzfgMdxvF9XKAD6M9qe+aM/md8QVybeGjxMba/9U23JUS0Hy9WOq38PBZMprP5sKw1nRf9IRa25TSD6fWzSWpSNplWeeh7Trj0KAFwJr0QaEITGuWu4nSqUwmk9mREe+ySFzUWURp1yzki1Z+Z0ZaFXQM3VxcNB9xdDntk2KBbVY0PxSyoBlAXfZhkuTp3usR+5FM2mhngJ8Awp42QgGbVLEPRsLJT2NGF1//KyioEnG+5ceoIj/bqYygPBkMCTL+M/SJPeAf7DJ9WNRsD0d7mU8EwMd6tIJKJULEzQ3bQLUBfhg8Y1KfIrcjqMFmbTLiwaq3dZE+KxwSMd5JAeOR0iBUc5YenaWzysRZMt5LBLd/mgeTuPIF7fSdt6u4KxWho5qRWahibjLst+EUNFPAUmeQT4jJiEMLyGlQk284/TP6YrDY88azMuKnTmyqS/QTnWFU=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    